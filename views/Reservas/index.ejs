<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Reservas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .reservation-card {
      transition: transform 0.3s ease;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .reservation-card:hover {
      transform: translateY(-5px);
    }

    .loading-spinner {
      display: none;
    }

    .alert-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      min-width: 300px;
    }

    .status-badge {
      font-size: 0.8em;
    }

    .revenue-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/inicio"><i class="fas fa-film me-2"></i>CineSystem</a>
      <div class="navbar-nav">
        <% if(rol=='admin' || rol=='gerente' ) {%>
          <a class="nav-link" href="/users/registro"><i class="fas fa-user me-1"></i>Agregar usuario</a>
          <% } %>
            <a class="nav-link" href="/peliculas"><i class="fas fa-movie me-1"></i>Películas</a>
            <a class="nav-link" href="/salas"><i class="fas fa-theater-masks me-1"></i>Salas</a>
            <a class="nav-link" href="/funciones"><i class="fas fa-calendar-alt me-1"></i>Funciones</a>
            <a class="nav-link" href="/clientes"><i class="fas fa-users me-1"></i>Clientes</a>
            <a class="nav-link active" href="/reservas"><i class="fas fa-ticket-alt me-1"></i>Reservas</a>
            <a class="nav-link" href="/users/logout"><i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesión</a>

      </div>
    </div>
  </nav>

  <div class="container my-4">
    <div class="row">
      <div class="col-12">
        <h1 class="display-5 fw-bold text-danger"><i class="fas fa-ticket-alt me-2"></i>Gestión de Reservas</h1>
        <p class="lead">Administra las reservas de tus clientes</p>
      </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body text-center">
            <h4 id="totalReservas">
              <%= data.length %>
            </h4>
            <p class="mb-0">Total Reservas</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body text-center">
            <h4 id="reservasHoy">
              <%= funcionesHoy %>
            </h4>
            <p class="mb-0">Hoy</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-white">
          <div class="card-body text-center">
            <h4 id="totalAsientos">
              <%= asientos_vendiodos %>
            </h4>
            <p class="mb-0">Asientos Vend.</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card revenue-card">
          <div class="card-body text-center">
            <h4 id="ingresosReservas">$<%= totalIngresos %>
            </h4>
            <p class="mb-0">Ingresos</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Formulario -->
      <div class="col-lg-6">
        <div class="card reservation-card">
          <div class="card-header bg-danger text-white">
            <h4 class="mb-0"><i class="fas fa-ticket-alt me-2"></i>Nueva Reserva</h4>
          </div>
          <div class="card-body">
            <form id="formReserva" action="/reservas/crear" method="post">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Función</label>
                  <select class="form-select" name="funcion_id" id="funcion_id" required>
                    <option value="" disabled selected>Seleciona</option>
                    <% if (funciones.length> 0) {%>
                      <% funciones.forEach(function(funcion) { %>
                        <option value="<%= funcion.id %>">
                          Pelicula: <%= funcion.titulo %> - Sala <%= funcion.sala %>
                        </option>
                        <% }); %>
                          <% }%>

                  </select>
                  <div class="form-text">
                    <small>Seleciona una función</small>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Cliente</label>
                  <select class="form-select" name="cliente_id" id="cliente_id" required>
                    <option value="" disabled selected>Seleciona</option>
                    <% if (clientes.length) {%>
                      <% clientes.forEach(function(cliente) { %>
                        <option value="<%= cliente.id %>">
                          <%= cliente.nombre %>
                        </option>
                        <% }); %>
                          <% }%>
                  </select>
                  <div class="form-text">
                    <small>Seleciona un cliente</small>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Número de Asientos *</label>
                  <input type="number" name="cantidad" class="form-control" id="asientos" min="0" onchange="calcular()"
                    max="10" value="" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Total a Pagar ($)</label>
                  <input type="number" name="total" step="0.01" class="form-control" value="0" id="total" readonly>
                </div>
              </div>

              <div class="alert alert-info" id="infoFuncion">
                <i class="fas fa-info-circle me-2"></i>
                <small>Selecciona una función y cliente válidos</small>
              </div>

              <button type="submit" class="btn btn-danger w-100" id="btnSubmit">
                <i class="fas fa-shopping-cart me-2"></i>Confirmar Reserva
              </button>
            </form>
          </div>
        </div>

        <!-- Búsqueda por Fecha -->
        <div class="card reservation-card mt-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-search me-2"></i>Buscar Reservas</h5>
          </div>
          <form action="/reservas/rango" method="post">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-2">
                  <label class="form-label">Desde</label>
                  <input type="date" name="desde" class="form-control" id="fechaInicio">
                </div>
                <div class="col-md-6 mb-2">
                  <label class="form-label">Hasta</label>
                  <input type="date" name="hasta" class="form-control" id="fechaFin">
                </div>
              </div>
              <button class="btn btn-outline-info w-100" type="submit">
                <i class="fas fa-filter me-2"></i>Filtrar Reservas
              </button>
          </form>
          <form action="/reservas" method="get">
            <button class="btn btn-outline-secondary w-100 mt-2" type="submit">
              <i class="fas fa-sync-alt me-2"></i>Mostrar Todas
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Lista de Reservas -->
    <div class="col-lg-6">
      <div class="card reservation-card">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-list me-2"></i>Lista de Reservas</h4>
          <div>
            <span class="badge bg-light text-dark" id="contadorReservas">
              <%= data.length %> reservas
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="loading-spinner text-center mb-3" id="loadingReservas">
            <div class="spinner-border text-danger" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando reservas...</p>
          </div>
          <div id="listaReservas" class="row g-3">
            <% if(data.length> 0 ) { %>
              <% data.forEach(function(reserva){ const fechaReserva=new Date(reserva.fechaReserva); const ahora=new
                Date(); const esReciente=(ahora - fechaReserva) < (24 * 60 * 60 * 1000); %>
                <div class="card reservation-card <%= esReciente ? 'border-success' : '' %>">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-md-8">
                        <div class="d-flex justify-content-between align-items-start">
                          <h5 class="card-title text-danger">Reserva #<%= reserva.id_reserva %>
                          </h5>
                          <span class="badge <%= esReciente ? 'bg-success' : 'bg-secondary' %> status-badge">
                            <%= esReciente ? 'NUEVA' : 'CONFIRMADA' %>
                          </span>
                        </div>

                        <p class="card-text mb-1">
                          <i class="fas fa-user me-1 text-muted"></i>
                          <strong>Cliente:</strong>
                          <%= reserva.cliente || 'Cliente no encontrado' %>
                        </p>

                        <p class="card-text mb-1">
                          <i class="fas fa-film me-1 text-muted"></i>
                          <strong>Película:</strong>
                          <%= reserva.titulo || 'Película no disponible' %>
                        </p>

                        <p class="card-text mb-1">
                          <i class="fas fa-calendar me-1 text-muted"></i>
                          <small class="text-muted">
                            Función: <%= reserva.fecha ? new Date(reserva.fecha).toLocaleDateString() : 'N/A' %>
                              <%= reserva.hora || '' %>
                          </small>
                        </p>

                        <p class="card-text mb-1">
                          <i class="fas fa-chair me-1 text-muted"></i>
                          <strong>Asientos:</strong>
                          <%= reserva.asientos %> |
                            <strong>Total:</strong> $<%= reserva.total %>
                        </p>

                        <small class="text-muted">
                          Reserva realizada: <%= fechaReserva.toLocaleString() %>
                        </small>
                      </div>
                      <div class="col-md-4 text-end">
                        <button type="button" onclick="elimnarNombre('<%= reserva.id_reserva %>')" name="Eliminar"
                          id="eliminar" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
                          data-bs-target="#eliminarModal">
                          <i class="fas fa-trash me-1"></i>Cancelar
                        </button>
                        <br>
                        <small class="text-muted mt-2 d-block">
                          Estado: <span class="text-success">
                            <%= reserva.estado || 'confirmada' %>
                          </span>
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
                <% })%>
                  <% } else { %>
                    <div class="col-12 text-center">
                      <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No hay reservas registradas
                      </div>
                    </div>
                    <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="eliminarModalLabel">Eliminar pelicula</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          ¿Estás seguro de que deseas cancelar esta reserva?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <form action="/reservas/eliminar/" id="formEliminar" method="post">
            <button type="submit" class="btn btn-danger">Confirmar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let funciones = '<%- JSON.stringify(funciones) %>';
    let data = JSON.parse(funciones);

    const calcular = () => {
      const funcionSelect = document.getElementById('funcion_id');
      const asientosInput = document.getElementById('asientos');
      const totalInput = document.getElementById('total');
      const infoFuncion = document.getElementById('infoFuncion');

      const funcionId = funcionSelect.value;
      const cantidadAsientos = parseInt(asientosInput.value) || 0;

      const funcionSeleccionada = data.find(f => f.id == funcionId);

      if (funcionSeleccionada) {
        const precioUnitario = parseFloat(funcionSeleccionada.precio) || 0;
        const totalPagar = precioUnitario * cantidadAsientos;
        totalInput.value = totalPagar.toFixed(2);

        infoFuncion.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <small>
                        Precio Unitario: $${precioUnitario.toFixed(2)} |
                        Total a Pagar por ${cantidadAsientos} asiento(s): $${totalPagar.toFixed(2)}
                    </small>
                `;
      } else {
        totalInput.value = '0.00';
        infoFuncion.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <small>Selecciona una función válida</small>
                `;
      }
    }

    const elimnarNombre = (id) => {
      document.getElementById('formEliminar').action = `/reservas/eliminar/${id}?_method=DELETE`;
    }

  </script>
</body>

</html>